<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>WhatsApp Tool</title>
</head>
<body>
<h1 style="text-align: center;">Start a new chat in WhatsApp</h1>

<div class="form">
	<form>
		<label for="dial">Dialing Code:</label>
		<input type="text" id="dial" name="dial" style="height:50px; width:100px"><br><br>
		<label for="number">Phone Number:</label>
		<input type="text" id="number" name="number" style="height:50px; width:230px" autofocus><br><br>
		<label for="message">Message (Optional):</label>
		<input type="text" id="message" name="message" style="height:50px; width:200px"><br><br>
		<input id="button" type="button" onclick="onSubmit()" value="Start" style="height:50px; width:350px">
	</form>
</div>

<script>
initDialingCode()
bindInputToButton("number", "button");
bindInputToButton("message", "button");

function onSubmit() {
	const urlBase = "https://wa.me/";
	let phone = normalizePhoneNumber(document.getElementById("number").value);
	let dialingCode = document.getElementById("dial").value;
	let message = document.getElementById("message").value;
	
	let url = urlBase + dialingCode + phone;
	
	if(message) {
		url += "?text=" + message;
	}
	
	console.log("url: " + url);
	url = encodeURI(url);
	window.open(url, '_blank').focus();
}

function normalizePhoneNumber(phoneNumber) {
	phoneNumber = phoneNumber.replace(/-/gi, ''); // remove '-'
	phoneNumber = phoneNumber.replace(/\s+/gi, ''); // remove whitespaces
	phoneNumber = +phoneNumber; // convert to number to remove leading '0'
	return phoneNumber;
}

function bindInputToButton(inputId, buttonId) {
	document.querySelector(`#${inputId}`).addEventListener("keydown", event => {
		if(event.key !== "Enter") return;
		document.querySelector(`#${buttonId}`).click()
		event.preventDefault();
	});
}

function initDialingCode() {
	getDialingCode().then(dialingCode => {document.getElementById("dial").value = dialingCode});
}

async function getDialingCode() {
	try {
		const response = await fetch("https://ipapi.co/country_calling_code/");
		if(response.ok) {
			let dialingCode = await response.text();
			console.log("dialingCode: " + dialingCode);
			return dialingCode.replace(/\+/gi, ''); // remove '+'
		} else {
			throw new Error(response.statusText);
		}
	}
	catch(error) {
		console.error("getDialingCode error: " + error.message)
	}

	return "";
}

</script>

</body>

<style>
	div.form
	{
		display: block;
		text-align: center;
	}
	form
	{
		display: inline-block;
		margin-left: auto;
		margin-right: auto;
		text-align: left;
	}
</style>
</html>
