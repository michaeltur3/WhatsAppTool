<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="#7952b3">
	<title>WhatsApp Tool</title>
	
	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
	
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-KZCLP0HVBW"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'G-KZCLP0HVBW');
	</script>
	<style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
    </style>
	<link href="signin.css" rel="stylesheet">
</head>

<body class="text-center">
<main class="form-signin">
	<form>
		<img class="d-block mx-auto mb-4" src="http://tribona.co.il/media/k2/items/cache/82f87882866fcce76dca31189f8b0135_XL.jpg" alt="" width="90" height="69">
		<h1 class="h3 mb-3 fw-normal">Start a new chat in WhatsApp.</h1>
		<div class="form-floating">
			<input type="text" class="form-control" id="dial" name="dial" placeholder="Dialing Code" value="">
			<label for="dial">Dialing Code</label>
		</div>
		<div class="form-floating">
			<input type="text" class="form-control" id="number" name="number" placeholder="Phone Number" autofocus required>
			<div class="invalid-feedback">
				Phone number is required.
			</div>
			<label for="number">Phone Number</label>
		</div>
		<div class="form-floating">
			<input type="text" class="form-control" id="message" name="message" placeholder="Message" value="">
			<label for="message">Message (Optional)</label>
		</div>
		<button class="w-100 btn btn-lg btn-primary mt-3" type="submit" onclick="onSubmit()">Start Chat</button>
		<p class="mt-5 mb-3 text-muted">&copy; 2021 Michael Turgeman</p>
	</form>
</main>


<script>
initDialingCode()
bindInputToButton("number", "button");
bindInputToButton("message", "button");

function onSubmit() {
	const urlBase = "https://wa.me/";
	let phone = normalizePhoneNumber(document.getElementById("number").value);
	let dialingCode = normalizeDialingCode(document.getElementById("dial").value);
	let message = document.getElementById("message").value;
	
	let url = urlBase + dialingCode + phone;
	
	if(message) {
		url += "?text=" + message;
	}
	
	console.log("url: " + url);
	url = encodeURI(url);
	window.open(url, '_blank').focus();
}

function normalizeDialingCode(dialingCode) {
	dialingCode = dialingCode.replace(/\+/gi, ''); // remove '+'
	dialingCode = dialingCode.replace(/\s+/gi, ''); // remove whitespaces
	return dialingCode;
}

function normalizePhoneNumber(phoneNumber) {
	phoneNumber = phoneNumber.replace(/\-/gi, ''); // remove '-'
	phoneNumber = phoneNumber.replace(/\s+/gi, ''); // remove whitespaces
	phoneNumber = +phoneNumber; // convert to number to remove leading '0'
	return phoneNumber;
}

function bindInputToButton(inputId, buttonId) {
	document.querySelector(`#${inputId}`).addEventListener("keydown", event => {
		if(event.key !== "Enter") return;
		document.querySelector(`#${buttonId}`).click()
		event.preventDefault();
	});
}

function initDialingCode() {
	getDialingCode().then(dialingCode => {document.getElementById("dial").value = dialingCode});
}

async function getDialingCode() {
	try {
		const response = await fetch("https://ipapi.co/country_calling_code/");
		if(response.ok) {
			let dialingCode = await response.text();
			console.log("dialingCode: " + dialingCode);
			return normalizeDialingCode(dialingCode);
		} else {
			throw new Error(response.statusText);
		}
	}
	catch(error) {
		console.error("getDialingCode error: " + error.message)
	}

	return "";
}

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.min.js" integrity="sha384-j0CNLUeiqtyaRmlzUHCPZ+Gy5fQu0dQ6eZ/xAww941Ai1SxSY+0EQqNXNE6DZiVc" crossorigin="anonymous"></script>
<script src="form-validation.js"></script>
</body>
</html>
